package database

import (
	"context"
	"strings"
	"time"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/bson/primitive"
	"go.mongodb.org/mongo-driver/mongo/options"
)

var (
	// CategorySafe means that we should not be blocking the file.
	CategorySafe = "safe"
	// CategoryMalicious means that this is a harmful file which we should block.
	CategoryMalicious = "malicious"
	// CategorySuspicious means that this file might be problematic. We should
	// block it in order to be safe, unless there's an exception for this type
	// of file.
	CategorySuspicious = "suspicious"
	// CategoryPUA means the file is a Potentially Unwanted Application. This is a
	// broad category of applications, some of which dangerous, others - not.
	CategoryPUA = "pua"

	// SkylinkStatusNew is the status of the skylink when it's created.
	SkylinkStatusNew = "new"
	// SkylinkStatusScanning is the status of the skylink while it's being
	// scanned.
	SkylinkStatusScanning = "scanning"
	// SkylinkStatusComplete is the status of the skylink after it's scanned.
	SkylinkStatusComplete = "complete"
)

// Skylink represents a skylink in the queue and holds its scanning status.
type Skylink struct {
	ID        primitive.ObjectID `bson:"_id,omitempty" json:"-"`
	Skylink   string             `bson:"skylink" json:"skylink"`
	Timestamp time.Time          `bson:"timestamp" json:"timestamp"`
	Status    string             `bson:"status" json:"status"`
	Category  string             `bson:"category" json:"category"`
}

// SkylinkCreate creates a new skylink. If the skylink already exists it does
// nothing.
func (db *DB) SkylinkCreate(ctx context.Context, skylink Skylink) error {
	_, err := db.Skylinks.InsertOne(ctx, skylink)
	if err != nil && strings.Contains(err.Error(), "E11000 duplicate key error collection: scanner.skylinks index: skylink_unique") {
		// This skylink already exists in the DB.
		return nil
	}
	return err
}

// SkylinkUpdate updates a skylink. If the skylink doesn't exist, it creates it.
func (db *DB) SkylinkUpdate(ctx context.Context, skylink Skylink) error {
	filter := bson.M{"skylink": skylink.Skylink}
	update := bson.M{
		"$set": bson.M{
			"timestamp": skylink.Timestamp,
			"status":    skylink.Status,
			"category":  skylink.Category,
		},
	}
	opts := &options.UpdateOptions{Upsert: &True}
	_, err := db.Skylinks.UpdateOne(ctx, filter, update, opts)
	return err
}
